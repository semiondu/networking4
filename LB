import socket
import threading


# default port for sockets
PORT = 80

#Servers addresses
server1_ip = '192.168.0.101'
server2_ip = '192.168.0.102'
server3_ip = '192.168.0.103'

musicList = []
videoList = []
pictureList = []

class Job:
    def __init__(self, data, conn, addr):
        self.data = data
        self.conn = conn
        self.addr = addr
        self.type = ''


class ClientThread (threading.Thread):
    def __init__ (self, conn, addr):
        self.conn = conn
        self.addr = addr
        threading.Thread.__init__ (self)

    def run (self):
        print 'recieved connection: ' ,self.addr
        data = self.conn.recv(1024)
        job = Job(data, self.conn, self,addr)
        enqueueJob(job)
        print 'returned fron enqueueJob'
        doJob()
        self.conn.close()
        print 'connection closed with: ', self.addr

def enqueueJob(job):
    
    if job.data[0] == 'M':
        job.type = 'music'
        musicList.append(job)
        print ('job of type Music was appended to music list')
    elif data[0] == 'V':
        videoList.append(job)
        job.type = 'video'
        print ('job of type Video was appended to video list')
    else:
        job.type = 'picture'
        pictureList.append(job)
        print ('job of type picture was appended to picture list')

    return

def doJob():
    #there is a video on the list
    if not len(videoList) == 0:
        job1 = videoList.pop(0)
        s1.send(job1.data)
        print ('data sent to s1')


        #there is a second video on the list
        if not len(videoList) == 0:
            job2 = videoList.pop(0)
            s2.send(job2.data)
            print ('data sent to s2')


            #there is music file on the list
            if not len(musicList) == 0:
                job3 = musicList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return


            #there were 2 videos, but no music
            elif len(pictureList) > 2:
                job3 = pictureList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            #there were 2 videos, no music, and less than 2 pictures
            elif len(videoList) > 3:
                job3 = videoList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            else:
                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return


        #there was only one video
        elif not len(pictureList) == 0:
            job2 = pictureList.pop(0)
            s2.send(job2.data)
            print ('data sent to s2')


            #there was one video, and there is a picture
            if not len(musicList) == 0:
                job3 = musicList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            #there was only one video,there was a picture and no music
            elif len(pictureList) > 2:
                job3 = pictureList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            else:
                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return


        #there was only one video, no pictures
        elif not len(musicList) == 0:
            job3 = musicList.pop(0)
            s3.send(job3.data)
            print ('data sent to s3')


            #there was only one video, no pictures and a music file
            if len(musicList) > 2:
                job2 = musicList.pop(0)
                s2.send(job2.data)
                print ('data sent to s2')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            else:
                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return
        else:
            reply1 = s1.recv(1024)
            print 'S1 executed. reply is: ', reply1
            job1.conn.send(reply1)
            print 'reply was sent back to ', job1.addr

            return


    #there were no videos at all
    elif not len(pictureList) == 0:
        job2 = pictureList.pop(0)
        s2.send(job2.data)
        print ('data sent to s2')


        #there were no videos, but there was a picture
        if not len(pictureList) == 0:
            job1 = pictureList.pop(0)
            s1.send(job1.data)
            print ('data sent to s2')


            #there were no videos, and two pictures, and there is music file
            if not len(musicList) == 0:
                job3 = musicList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return


            #there were no videos, 2 pictures and no music
            elif len(pictureList) > 2:
                job3 = pictureList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            else:
                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return


        #there were no videos, only one picture
        elif not len(musicList) == 0:
                job3 = musicList.pop(0)
                s3.send(job3.data)
                print ('data sent to s3')


                #there were no videos, only one picture and a music file
                if len(musicList) > 2:
                    job2 = musicList.pop(0)
                    s2.send(job2.data)
                    print ('data sent to s2')

                    reply3 = s3.recv(1024)
                    print 'S3 executed. reply is: ', reply3
                    job3.conn.send(reply3)
                    print 'reply was sent back to ' ,job3.addr

                    reply2 = s2.recv(1024)
                    print 'S2 executed. reply is: ', reply2
                    job2.conn.send(reply2)
                    print 'reply was sent back to ', job2.addr

                    reply1 = s1.recv(1024)
                    print 'S1 executed. reply is: ', reply1
                    job1.conn.send(reply1)
                    print 'reply was sent back to ', job1.addr

                    return

                else:
                    reply3 = s3.recv(1024)
                    print 'S3 executed. reply is: ', reply3
                    job3.conn.send(reply3)
                    print 'reply was sent back to ' ,job3.addr

                    reply1 = s1.recv(1024)
                    print 'S1 executed. reply is: ', reply1
                    job1.conn.send(reply1)
                    print 'reply was sent back to ', job1.addr

                    return

        else:
            reply2 = s2.recv(1024)
            print 'S2 executed. reply is: ', reply2
            job2.conn.send(reply2)
            print 'reply was sent back to ', job2.addr

            return


    #there are no videos and no pictures at all
    elif not len(musicList) == 0:
        job3 = musicList.pop(0)
        s3.send(job3.data)
        print ('data sent to s3')

        #there were no videos, no pictures at all and at least one music
        if len(musicList) > 2:
            job1 = pictureList.pop(0)
            s1.send(job.data)
            print ('data sent to s1')

            #there were no videos, no pictures at all, and at least two music
            if len(musicList) > 2:
                job2 = pictureList.pop(0)
                s2.send(job2.data)
                print ('data sent to s2')
                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply2 = s2.recv(1024)
                print 'S2 executed. reply is: ', reply2
                job2.conn.send(reply2)
                print 'reply was sent back to ', job2.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

            else:
                reply3 = s3.recv(1024)
                print 'S3 executed. reply is: ', reply3
                job3.conn.send(reply3)
                print 'reply was sent back to ' ,job3.addr

                reply1 = s1.recv(1024)
                print 'S1 executed. reply is: ', reply1
                job1.conn.send(reply1)
                print 'reply was sent back to ', job1.addr

                return

        else:
            reply3 = s3.recv(1024)
            print 'S3 executed. reply is: ', reply3
            job3.conn.send(reply3)
            print 'reply was sent back to ' ,job3.addr

            return


    return


try:
    s1 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    print "Socket2 successfully created"
except socket.error as err:
    print "socket creation failed with error %s" %(err)

try:
    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    print "Socket2 successfully created"
except socket.error as err:
    print "socket creation failed with error %s" %(err)

try:
    s3 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    print "Socket3 successfully created"
except socket.error as err:
    print "socket creation failed with error %s" %(err)


# connecting to server1
s1.connect((server1_ip, PORT))
print "the socket has successfully connected to server1 on port == %s" %(server1_ip)


# connecting to server2
s2.connect((server2_ip, PORT))
print "the socket has successfully connected to server2 on port == %s" %(server2_ip)

# connecting to server3
s3.connect((server3_ip, PORT))
print "the socket has successfully connected to server3 on port == %s" %(server3_ip)


#creating a listening Socket
SClient = socket.socket()
SClient.bind(('', PORT))
SClient.listen(5)

print "Client socket is listening"
conn, addr = SClient.accept()

while True:
    conn, addr = SClient.accept()
    ClientThread(conn, addr).start()
    # for i in range(5):
    #     conn, addr = SClient.accept()
    #     print('Connected by', addr, i)
    #     i = i+1
    #     data = conn.recv(1024)
    #     if not data:
    #         break
    #     job = Job(data, conn, addr)
    #     enqueueJob(job)
    #     print 'returned from enqueueJob'
    #     SClient.listen(0)
    # doJob()
# print musicList
# print videoList
# print pictureList
# doJob()
    #conn, addr = SClient.accept()
    #print ('accepted another one', addr)
        # conn.send (reply)
        # print 'reply was sent back to ', addr
    
